name: Prometheus Metrics
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  export-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Install prom-client
        run: npm install prom-client

      - name: Generate Prometheus Metrics
        run: |
          node -e "
          const client = require('prom-client');
          const collectDefaultMetrics = client.collectDefaultMetrics;
          collectDefaultMetrics({ timeout: 5000 });

          // Ajouter des métriques personnalisées
          const testDuration = new client.Gauge({
            name: 'test_duration_seconds',
            help: 'Durée des tests en secondes'
          });
          testDuration.set(45.2);

          const testsPassed = new client.Counter({
            name: 'tests_passed',
            help: 'Nombre de tests réussis'                                                                                                                                                        
          });
          testsPassed.inc(8);

          const testsFailed = new client.Counter({
            name: 'tests_failed',
            help: 'Nombre de tests échoués'
          });
          testsFailed.inc(2);

          // Générer le fichier de métriques
          const fs = require('fs');
          client.register.metrics().then(metrics => {
            fs.writeFileSync('metrics.prom', metrics);
          });
          "                                                                                                                                                                                        

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: prometheus-metrics
          path: metrics.prom
          retention-days: 30

      - name: Push to Grafana Cloud
        if: env.GRAFANA_URL != '' && env.GRAFANA_SERVICE_ACCOUNT_TOKEN != ''
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GRAFANA_SERVICE_ACCOUNT_TOKEN }}" \
            -H "Content-Type: text/plain" \
            --data-binary @metrics.prom \
            "${{ secrets.GRAFANA_CLOUD_URL }}/api/prom/push"
        env:
          GRAFANA_CLOUD_URL: ${{ secrets.GRAFANA_CLOUD_URL }}
          GRAFANA_SERVICE_ACCOUNT_TOKEN: ${{ secrets.GRAFANA_SERVICE_ACCOUNT_TOKEN }}
