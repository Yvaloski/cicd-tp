name: Prometheus Metrics
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  export-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Install Prometheus Exporter
        run: npm install -g github-actions-prometheus-exporter

      - name: Export Metrics
        run: |
          github-actions-prometheus-exporter \
            --workflow-run-id=${{ github.event.workflow_run.id }} \
            --github-token=${{ secrets.GITHUB_TOKEN }} \
            --output-file=metrics.prom

      - name: Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: prometheus-metrics
          path: metrics.prom
          retention-days: 30

      - name: Push to Prometheus (if available)
        if: env.PROMETHEUS_PUSHGATEWAY_URL != ''
        run: |
          curl -X POST \
            -H "Content-Type: text/plain" \
            --data-binary @metrics.prom \
            "${{ secrets.PROMETHEUS_PUSHGATEWAY_URL }}/metrics/job/github-actions"
        env:
          PROMETHEUS_PUSHGATEWAY_URL: ${{ secrets.PROMETHEUS_PUSHGATEWAY_URL }}
